---
description: 交易策略代码修改必须经过两轮验证，防止引入逻辑错误导致资金损失
alwaysApply: true
---

# 交易策略代码双重校验规则

对以下目录/文件的任何代码修改，必须严格执行**两轮校验**后才能完成：

## 适用范围

- `src/trading/` — 自动交易策略、下单逻辑、止盈止损
- `src/analysis/` — AI 信号分析、策略参考
- `server.py` 中与 `/api/quant/` 相关的交易接口
- `desktop/src/components/QuantTradingPanel.tsx` — 交易面板 UI 与参数传递
- `desktop/src/api.ts` — 交易相关 API 调用

## 两轮校验流程

### 第一轮：逻辑正确性

修改完成后，立即回读改动代码，逐行检查：

1. **数值计算**：乘除方向、单位是否正确（如 ATR 倍数、百分比与小数转换）
2. **条件判断**：买卖方向是否反了、大于小于号是否正确、边界值处理
3. **状态管理**：锁的获取/释放是否配对、线程安全、缓存读写一致性
4. **参数传递**：前后端字段名是否一致、类型是否匹配、默认值是否合理

### 第二轮：副作用与兼容性

1. **资金安全**：改动是否可能导致意外开仓、重复下单、止损失效
2. **持久化一致**：新增字段是否同步更新了 `_save_config`、`_load_state`、前端加载逻辑
3. **接口兼容**：API 请求/响应结构改动是否前后端同步、TypeScript 类型是否更新
4. **回归风险**：是否影响已有持仓管理、是否破坏现有止盈止损逻辑

## 输出格式

每次策略相关改动完成后，必须输出校验摘要：

```
✅ 第一轮校验（逻辑正确性）：
- [检查项]: 通过/发现问题 → 已修复

✅ 第二轮校验（副作用与兼容性）：
- [检查项]: 通过/发现问题 → 已修复
```

如果任一轮发现问题，必须先修复再重新校验，直到两轮全部通过。
